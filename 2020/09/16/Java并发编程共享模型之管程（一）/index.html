<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Java并发编程共享模型之管程（一） | 我的笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="[TOC] Java并发编程共享模型之管程本章内容共享问题 synchronized 线程安全分析 Monitor 共享带来的问题    Java的体现 两个线程对初始值为0的静态变量一个做自增，一个做自减，各做5000次，结果是0吗？ 12345678910111213141516171819202122232425262728293031public class Demo01 &amp;#123;">
<meta property="og:type" content="article">
<meta property="og:title" content="Java并发编程共享模型之管程（一）">
<meta property="og:url" content="http://yoursite.com/2020/09/16/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%AE%A1%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/index.html">
<meta property="og:site_name" content="我的笔记">
<meta property="og:description" content="[TOC] Java并发编程共享模型之管程本章内容共享问题 synchronized 线程安全分析 Monitor 共享带来的问题    Java的体现 两个线程对初始值为0的静态变量一个做自增，一个做自减，各做5000次，结果是0吗？ 12345678910111213141516171819202122232425262728293031public class Demo01 &amp;#123;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/wggnaD.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/wggJqf.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/wggtZ8.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/wggdiQ.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/wg4HeI.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/wg5m6J.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/wgIVEt.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/wgIJU0.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/w2eMDg.md.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/w2siqO.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/w2cdyt.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/w22XdK.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/16/w2fnrn.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfpUc4.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfpsN6.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfphDA.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wf98rd.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfF9eJ.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfFcXF.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfF4t1.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfkCjS.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfkg8P.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfemOf.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfeY60.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfKkHf.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfK1bV.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfKugs.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfQAfg.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfQlkT.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wf3VpD.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wf3e6H.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfGFzD.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfGmdI.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfNHv8.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfNLDg.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfUSCq.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfUiKU.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfUodJ.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfUHiR.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wfa4pt.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wf0511.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wf07nK.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wf0b7D.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/17/wf0LAe.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/18/wfbVjP.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/18/wfbenf.png">
<meta property="article:published_time" content="2020-09-16T08:30:01.809Z">
<meta property="article:modified_time" content="2020-09-18T01:02:59.493Z">
<meta property="article:author" content="我的笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2020/09/16/wggnaD.png">
  
    <link rel="alternate" href="/atom.xml" title="我的笔记" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">我的笔记</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Java并发编程共享模型之管程（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/16/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%AE%A1%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time datetime="2020-09-16T08:30:01.809Z" itemprop="datePublished">2020-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Java并发编程共享模型之管程（一）
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>[TOC]</p>
<h1 id="Java并发编程共享模型之管程"><a href="#Java并发编程共享模型之管程" class="headerlink" title="Java并发编程共享模型之管程"></a>Java并发编程共享模型之管程</h1><h4 id="本章内容"><a href="#本章内容" class="headerlink" title="本章内容"></a>本章内容</h4><p>共享问题</p>
<p>synchronized</p>
<p>线程安全分析</p>
<p>Monitor</p>
<h4 id="共享带来的问题"><a href="#共享带来的问题" class="headerlink" title="共享带来的问题"></a>共享带来的问题</h4><p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wggnaD"><img src="https://s1.ax1x.com/2020/09/16/wggnaD.png" alt="wggnaD.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wggJqf"><img src="https://s1.ax1x.com/2020/09/16/wggJqf.png" alt="wggJqf.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wggtZ8"><img src="https://s1.ax1x.com/2020/09/16/wggtZ8.png" alt="wggtZ8.png"></a></p>
<p><img src="https://s1.ax1x.com/2020/09/16/wggdiQ.png" alt="wggdiQ.png"></p>
<p><strong>Java的体现</strong></p>
<p>两个线程对初始值为0的静态变量一个做自增，一个做自减，各做5000次，结果是0吗？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo01</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                    count--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t1.join();</span><br><span class="line">            t2.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;count的值是：&quot;</span> + count);<span class="comment">//count的值是：-1089   count的值是：0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次执行的结果几乎都不一样。</p>
<p><strong>问题分析</strong></p>
<p>以上的结果可能是正数、负数、零。为什么呢？因为Java中对静态变量的自增，自减并不是原子操作，要彻底理解，必须从字节码来进行分析。</p>
<p>例如对于i++而言（i为静态变量），实际会产生如下的JVM字节码指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getstatic	i <span class="comment">//获取静态变量i的值</span></span><br><span class="line">iconst_1	  <span class="comment">//准备常量1</span></span><br><span class="line">iadd	  	  <span class="comment">//自增</span></span><br><span class="line">putstatic     <span class="comment">//检修改后的值存入静态变量i</span></span><br></pre></td></tr></table></figure>

<p>而对应i–也是类似</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getstatic	i <span class="comment">//获取静态变量i的值</span></span><br><span class="line">iconst_1	  <span class="comment">//准备常量1</span></span><br><span class="line">isub	  	  <span class="comment">//自减</span></span><br><span class="line">putstatic     <span class="comment">//检修改后的值存入静态变量i</span></span><br></pre></td></tr></table></figure>

<p>而Java的内存模型如下，完成静态变量的自增，自减需要在主存和工作内存中进行数据交换。</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wg4HeI"><img src="https://s1.ax1x.com/2020/09/16/wg4HeI.png" alt="wg4HeI.png"></a></p>
<p>如果是单线程以上代码是顺序执行（不会交错）没有问题：</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wg5m6J"><img src="https://s1.ax1x.com/2020/09/16/wg5m6J.png" alt="wg5m6J.png"></a></p>
<p>但多线程以上代码可能交错运行：</p>
<p>出现负数的情况</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wgIVEt"><img src="https://s1.ax1x.com/2020/09/16/wgIVEt.png" alt="wgIVEt.png"></a></p>
<p>出现正数的情况</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wgIJU0"><img src="https://s1.ax1x.com/2020/09/16/wgIJU0.png" alt="wgIJU0.png"></a></p>
<p><strong>临界区Critical Section</strong></p>
<p>*一个程序运行多个线程本身是没有问题的</p>
<p>*问题出在多个线程访问共享资源</p>
<p>​    *多个线程读共享资源其实也没有问题</p>
<p>​    *在多线程对共享资源读写操作时发生指令交错，就会出现问题</p>
<p>*一段代码块内如果存在对共享资源的多线程读写操作，称这段代码块为临界区</p>
<p>例如，下面代码中的临界区</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">//临界区</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	count++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decrement</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">//临界区</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	count--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>竞态条件</strong></p>
<p>多个线程在临界区内执行，由于代码的<strong>执行序列不同</strong>而导致结果无法预测，称之为发生了<strong>竞态条件</strong>。</p>
<h4 id="synchronized解决方法"><a href="#synchronized解决方法" class="headerlink" title="synchronized解决方法"></a>synchronized解决方法</h4><p><strong>应用之互斥</strong></p>
<p>为了避免临界区的竞态条件发生，有多种手段可以达到目的。</p>
<p>*阻塞式的解决方案：synchronized,Lock</p>
<p>*非阻塞式的解决方案：原子变量</p>
<p>本章使用阻塞式的解决方法：synchronized,来解决上述问题，即俗称【对象锁】，它采用互斥的方式让同一时刻至多只用一个线程持有【对象锁】，其它线程在想获取这个【对象锁】时就会阻塞住，这样就能保证拥有锁的线程可以安全的执行临界区内的代码，不用担心线程上下文切换。</p>
<p><strong>注意</strong></p>
<p>虽然Java中互斥和同步都可以用synchronized关键字来完成，但它们还是有区别的：</p>
<p>1、互斥是保证临界区的竞态条件发生，同一时刻只能有一个线程执行临界区代码</p>
<p>2、同步是由于线程执行的先后，顺序不同，需要一个线程等待其它线程运行到某个点。</p>
<p><strong>synchronized</strong></p>
<p>语法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>（对象）&#123;</span><br><span class="line">	临界区</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>解决</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo02</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> Object object = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                        count++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                        count--;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t1.join();</span><br><span class="line">            t2.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;count的值是：&quot;</span> + count);<span class="comment">//count的值是：0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>图解原理</strong></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/w2eMDg"><img src="https://s1.ax1x.com/2020/09/16/w2eMDg.md.png" alt="w2eMDg.md.png"></a></p>
<p>synchronized实际使用<strong>对象</strong>保证了<strong>临界区内代码的原子性</strong>，临界区内的代码对外是不可分割的，不会被线程切换所打断。</p>
<p>为了加深理解，请思考下面的问题</p>
<p>1、如果把synchronized（obj）放在for循环的外面，如何理解？–原子性</p>
<p>答：for循环也加了锁，没有锁的for循环，这次就执行不进去，之前是能执行到的，到了加锁的地方才被阻塞住。</p>
<p>2、如果t1 synchronized（obj1）而synchronized（obj2)会怎样运作？–锁对象</p>
<p>没加一样，加锁必须是同一把</p>
<p>3、如果t1 synchronized（obj）而t2没有加会怎么样？如何理解？–锁对象</p>
<p>没加一样，加锁必须是同一把</p>
<p><strong>面向对象的改进</strong></p>
<p>把需要保护的共享变量放入一个类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo03</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Room room = <span class="keyword">new</span> Room();</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                    room.increment();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                    room.decrement();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t1.join();</span><br><span class="line">            t2.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;count的值是：&quot;</span> + room.getCount());<span class="comment">//count的值是：0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrement</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            count--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法上的synchronized"><a href="#方法上的synchronized" class="headerlink" title="方法上的synchronized"></a>方法上的synchronized</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">等价于</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">等价于</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span>(Test.class)&#123;</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>不加synchronized的方法</strong></p>
<p>不加synchronized的方法就好比不遵守规则的人，不老实排队（好比翻窗户进去的）</p>
<p><strong>所谓的“线程八锁”</strong></p>
<p>其实就是考察synchronized锁住的是哪个对象，分清this和类对象就可以了。</p>
<h4 id="变量的线程安全分析"><a href="#变量的线程安全分析" class="headerlink" title="变量的线程安全分析"></a>变量的线程安全分析</h4><p><strong>成员变量和静态变量是否线程安全？</strong></p>
<p>*如果它们没有共享，则线程安全</p>
<p>*如果它们被共享了。根据它们的状态是否能够改变，又分两种情况</p>
<p>​    *如果只用读操作，则线程安全</p>
<p>​    *如果有读写操作，则这段代码是临界区，需要考虑线程安全</p>
<p><strong>局部变量是否线程安全？</strong></p>
<p>*局部变量是线程安全的</p>
<p>*但局部变量应用的对象则未必</p>
<p>​    *如果该对象没有逃离方法的作用访问，它是线程安全的</p>
<p>​    *如果该对象逃离方法的作用范围，需要考虑线程安全</p>
<p><strong>局部变量线程安全分析</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">10</span>;</span><br><span class="line">	i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个线程调用test1（）方法时局部变量i，会在每个线程的栈帧内存中被创建多分，因此不存在共享。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">	desrciptor: ()v</span><br><span class="line">	flags: ACC_PUBLIC,ACC_STATIC</span><br><span class="line">	Code:</span><br><span class="line">		stack = <span class="number">1</span>,locals=<span class="number">1</span>,args_size=<span class="number">0</span></span><br><span class="line">			<span class="number">0</span>:bipush	<span class="number">10</span></span><br><span class="line">			<span class="number">2</span>:istore_0</span><br><span class="line">			<span class="number">3</span>:iinc		<span class="number">0</span>,<span class="number">1</span></span><br><span class="line">			<span class="number">6</span>:<span class="keyword">return</span></span><br><span class="line">		LineNumberTable:</span><br><span class="line">			line <span class="number">10</span>: <span class="number">0</span></span><br><span class="line">			line <span class="number">11</span>: <span class="number">3</span></span><br><span class="line">			line <span class="number">12</span>: <span class="number">6</span></span><br><span class="line">		LocalVariableTable:</span><br><span class="line">			Start	Length	Slot	Name	Signature</span><br><span class="line">				<span class="number">3</span>		<span class="number">4</span>		<span class="number">0</span>		i	I	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如图</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/w2siqO"><img src="https://s1.ax1x.com/2020/09/16/w2siqO.png" alt="w2siqO.png"></a></p>
<p><strong>局部变量的引用稍有不同</strong></p>
<p>先看一个成员变量的例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo04</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> THREAD_NUMBER = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOOP_NUMBER = <span class="number">200</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ThreadUnsafe test = <span class="keyword">new</span> ThreadUnsafe();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THREAD_NUMBER; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    test.method1(LOOP_NUMBER);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="string">&quot;thread&quot;</span> + (i + <span class="number">1</span>)).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadUnsafe</span></span>&#123;</span><br><span class="line">    ArrayList&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">(<span class="keyword">int</span> loopNunber)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNunber; i++) &#123;</span><br><span class="line">            method2();</span><br><span class="line">            method3();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        list.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果其中一种情况是，如果线程2还未add，线程1remove就会报错：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;thread2&quot;</span> Exception in thread <span class="string">&quot;thread1&quot;</span> java.lang.ArrayIndexOutOfBoundsException: -<span class="number">1</span></span><br><span class="line">	at java.util.ArrayList.remove(ArrayList.java:<span class="number">501</span>)</span><br><span class="line">	at demo.ThreadUnsafe.method3(demo04.java:<span class="number">35</span>)</span><br><span class="line">	at demo.ThreadUnsafe.method1(demo04.java:<span class="number">28</span>)</span><br><span class="line">	at demo.demo04$<span class="number">1.</span>run(demo04.java:<span class="number">17</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br><span class="line">java.lang.ArrayIndexOutOfBoundsException: -<span class="number">1</span></span><br><span class="line">	at java.util.ArrayList.add(ArrayList.java:<span class="number">459</span>)</span><br><span class="line">	at demo.ThreadUnsafe.method2(demo04.java:<span class="number">32</span>)</span><br><span class="line">	at demo.ThreadUnsafe.method1(demo04.java:<span class="number">27</span>)</span><br><span class="line">	at demo.demo04$<span class="number">1.</span>run(demo04.java:<span class="number">17</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br></pre></td></tr></table></figure>

<p><strong>分析</strong></p>
<p>*无论哪个线程中的method2引用的都是同一个对象中的list成员变量</p>
<p>*method3与method2分析相同</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/w2cdyt"><img src="https://s1.ax1x.com/2020/09/16/w2cdyt.png" alt="w2cdyt.png"></a></p>
<p><strong>将list修改为局部变量</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo05</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> THREAD_NUMBER = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOOP_NUMBER = <span class="number">200</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Threadsafe test = <span class="keyword">new</span> Threadsafe();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THREAD_NUMBER; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    test.method1(LOOP_NUMBER);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="string">&quot;thread&quot;</span> + (i + <span class="number">1</span>)).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Threadsafe</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">(<span class="keyword">int</span> loopNunber)</span></span>&#123;</span><br><span class="line">        ArrayList&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNunber; i++) &#123;</span><br><span class="line">            method2(list);</span><br><span class="line">            method3(list);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">(ArrayList&lt;Integer&gt; list)</span></span>&#123;</span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">(ArrayList&lt;Integer&gt; list)</span></span>&#123;</span><br><span class="line">        list.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么就不会有上述问题了</p>
<p><strong>分析</strong></p>
<p>1、list是局部变量，每个线程调用时会创建其不同实例，没有共享</p>
<p>2、而method2的参数是从method1中传递过来的，与method1中引用同一个对象</p>
<p>3、method3的参数分析与method2相同</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/w22XdK"><img src="https://s1.ax1x.com/2020/09/16/w22XdK.png" alt="w22XdK.png"></a></p>
<p>方法访问修饰符带来的思考，如果把 method2 和 method3 的方法修改为 public 会不会代理线程安全问题？<br> *情况1：有其它线程调用 method2 和 method3  （不会有线程安全问题）<br> *情况2：在 情况1 的基础上，为 ThreadSafe 类添加子类，子类覆盖 method2 或 method3 方法。会有线程安全问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadSafe</span> </span>&#123;</span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">(<span class="keyword">int</span> loopNumber)</span> </span>&#123;</span><br><span class="line">		 ArrayList&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">		 method2(list);</span><br><span class="line">		 method3(list);</span><br><span class="line">	 &#125;</span><br><span class="line">	 &#125;</span><br><span class="line">	 <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">	 	list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	 <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">	 	list.remove(<span class="number">0</span>);</span><br><span class="line">	 &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">ThreadSafeSubClass</span> <span class="keyword">extends</span> <span class="title">ThreadSafe</span></span>&#123;</span><br><span class="line">	 <span class="meta">@Override</span></span><br><span class="line">		 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">			 <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">			 	list.remove(<span class="number">0</span>);</span><br><span class="line">		 		&#125;).start();</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从这个例子可以看出private或final提供【安全】的意义所在，请体会开闭原则中的【闭】</p>
<p><strong>常见线程安全类</strong></p>
<p>String</p>
<p>Integer</p>
<p>StringBuffer</p>
<p>Random</p>
<p>Vector</p>
<p>Hashtable</p>
<p>java.util.concurrent包下的类</p>
<p>这里说它们是线程安全的是指，多个线程调用它们同一个实例的某个方法时，是线程安全的。也可以理解为</p>
<p> *它们的每个方法是原子的<br> *但注意它们多个方法的组合不是原子的，见后面分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Hashtable table = <span class="keyword">new</span> Hashtable();</span><br><span class="line"><span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line"> table.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value1&quot;</span>);</span><br><span class="line">&#125;).start();</span><br><span class="line"><span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line"> table.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value2&quot;</span>);</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>

<p><strong>线程安全类方法的组合</strong></p>
<p>分析下面代码是否线程安全？(不安全)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Hashtable table = <span class="keyword">new</span> Hashtable();</span><br><span class="line"><span class="comment">// 线程1，线程2</span></span><br><span class="line"><span class="keyword">if</span>( table.get(<span class="string">&quot;key&quot;</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line"> 	table.put(<span class="string">&quot;key&quot;</span>, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/w2fnrn"><img src="https://s1.ax1x.com/2020/09/16/w2fnrn.png" alt="w2fnrn.png"></a></p>
<h4 id="不可变类线程安全"><a href="#不可变类线程安全" class="headerlink" title="不可变类线程安全"></a>不可变类线程安全</h4><p>String、Integer等都是不可变类，因为其内部的状态不可以改变，因此它们的方法都是线程安全的。</p>
<p>有同学或许有疑问，String有substring等方法【可以】改变值啊，那么这些方法又是如何保证线程安全的呢？</p>
<p><strong>实例分析</strong></p>
<p>例1：Servlet运行在Tomcat环境下并只有一个实例，因此会被Tomcat的多个线程共享使用，因此存在成员变量的共享问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">	 <span class="comment">// 是否安全？  否：HashMap不是线程安全的，HashTable是</span></span><br><span class="line">	 Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	 <span class="comment">// 是否安全？  是:String 为不可变类，线程安全</span></span><br><span class="line">	 String S1 = <span class="string">&quot;...&quot;</span>;</span><br><span class="line">	 <span class="comment">// 是否安全？ 是</span></span><br><span class="line">	 <span class="keyword">final</span> String S2 = <span class="string">&quot;...&quot;</span>;</span><br><span class="line">	 <span class="comment">// 是否安全？ 否：不是常见的线程安全类</span></span><br><span class="line">	 Date D1 = <span class="keyword">new</span> Date();</span><br><span class="line">	 <span class="comment">// 是否安全？  否：引用值D2不可变，但是日期里面的其它属性比如年月日可变。与字符串的最大区别是Date里面的属性可变。</span></span><br><span class="line">	 <span class="keyword">final</span> Date D2 = <span class="keyword">new</span> Date();</span><br><span class="line"> </span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, 		HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">	  <span class="comment">// 使用上述变量</span></span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">	 <span class="comment">// 是否安全？  否：Servlet只有一份，userService为其成员变量也只有一份，所以会有多个线程共享使用。</span></span><br><span class="line">	 <span class="keyword">private</span> UserService userService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">	 </span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">	 	userService.update(...);</span><br><span class="line">	 &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">		 <span class="comment">// 记录调用次数   否：成员变量只有一份</span></span><br><span class="line">		 <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">		 </span><br><span class="line">		 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			 <span class="comment">// ...  临界区</span></span><br><span class="line">			 count++;</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例3：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAspect</span> </span>&#123;</span><br><span class="line">	 <span class="comment">// 是否安全？  否：Spring中没有加Scope默认为单例，因此为成员变量MyAspect会被共享，其成员变量也会被共享。解决：使用环绕通知，将开始时间和结束时间作为环绕通知的局部变量。</span></span><br><span class="line">	 <span class="keyword">private</span> <span class="keyword">long</span> start = <span class="number">0L</span>;</span><br><span class="line">	 </span><br><span class="line">	 <span class="meta">@Before(&quot;execution(* *(..))&quot;)</span></span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	 	start = System.nanoTime();</span><br><span class="line">	 &#125;</span><br><span class="line">	 </span><br><span class="line">	 <span class="meta">@After(&quot;execution(* *(..))&quot;)</span></span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		 <span class="keyword">long</span> end = System.nanoTime();</span><br><span class="line">		 System.out.println(<span class="string">&quot;cost time:&quot;</span> + (end-start));</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例4：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">		 <span class="comment">// 是否安全    是：UserService不可变，没有地方修改它</span></span><br><span class="line">		 <span class="keyword">private</span> UserService userService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">		 </span><br><span class="line">		 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">		 	userService.update(...);</span><br><span class="line">		 &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">		 <span class="comment">// 是否安全     是：Dao不可变</span></span><br><span class="line">		 <span class="keyword">private</span> UserDao userDao = <span class="keyword">new</span> UserDaoImpl();</span><br><span class="line">		 </span><br><span class="line">		 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		 userDao.update();</span><br><span class="line">		 &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123; </span><br><span class="line">		 <span class="comment">// 是否安全   是：没有成员变量，无法修改其状态和属性</span></span><br><span class="line">		 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		 	String sql = <span class="string">&quot;update user set password = ? where username = ?&quot;</span>;</span><br><span class="line">		 	<span class="comment">// 是否安全   是：不同线程创建的conn各不相同，都在各自的栈内存中</span></span><br><span class="line">		 	<span class="keyword">try</span> (Connection conn = DriverManager.getConnection(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">		 	<span class="comment">// ...</span></span><br><span class="line">		 	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		 	<span class="comment">// ...</span></span><br><span class="line">		 	&#125;</span><br><span class="line">		 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例5：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">	 <span class="comment">// 是否安全</span></span><br><span class="line">	 <span class="keyword">private</span> UserService userService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">	 	userService.update(...);</span><br><span class="line">	 &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">	 	<span class="comment">// 是否安全</span></span><br><span class="line">		 <span class="keyword">private</span> UserDao userDao = <span class="keyword">new</span> UserDaoImpl();</span><br><span class="line">		 </span><br><span class="line">		 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		 userDao.update();</span><br><span class="line">		 &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	 <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">		 <span class="comment">// 是否安全    否：conn为成员变量被多个线程共享</span></span><br><span class="line">		 <span class="keyword">private</span> Connection conn = <span class="keyword">null</span>;</span><br><span class="line">		 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">		 String sql = <span class="string">&quot;update user set password = ? where username = ?&quot;</span>;</span><br><span class="line">		 conn = DriverManager.getConnection(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">		 <span class="comment">// ...</span></span><br><span class="line">		 conn.close();</span><br><span class="line">		 &#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>例6：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">	 <span class="comment">// 是否安全   是</span></span><br><span class="line">	 <span class="keyword">private</span> UserService userService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">	 	userService.update(...);</span><br><span class="line">	 &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123; </span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	 <span class="comment">//是否安全：   是：因为userDao为局部变量，每个线程创建的都不一样（但不推荐，建议把conn作为线程内的局部变量）</span></span><br><span class="line">	 UserDao userDao = <span class="keyword">new</span> UserDaoImpl();</span><br><span class="line">	 	userDao.update();</span><br><span class="line">	 &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">	 <span class="comment">// 是否安全  </span></span><br><span class="line">	 <span class="keyword">private</span> Connection = <span class="keyword">null</span>;</span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">	 String sql = <span class="string">&quot;update user set password = ? where username = ?&quot;</span>;</span><br><span class="line">	 conn = DriverManager.getConnection(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">	 <span class="comment">// ...</span></span><br><span class="line">	 conn.close();</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例7：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	 <span class="comment">// 是否安全  否：虽然sdf 是局部变量，但是还要看是否暴露给其它线程</span></span><br><span class="line">	 SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">	 foo(sdf);</span><br><span class="line">	&#125;</span><br><span class="line"> 	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="title">foo</span><span class="params">(SimpleDateFormat sdf)</span></span>;</span><br><span class="line"> 	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> 		<span class="keyword">new</span> Test().bar();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 foo 的行为是不确定的，可能导致不安全的发生，被称之为<strong>外星方法</strong>。不想往外暴露方法设置为final或者private，String类加final就是防止子类将其属性或者状态覆盖。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(SimpleDateFormat sdf)</span> </span>&#123;</span><br><span class="line">	 String dateStr = <span class="string">&quot;1999-10-11 00:00:00&quot;</span>;</span><br><span class="line">	 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">		 <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">		 <span class="keyword">try</span> &#123;</span><br><span class="line">		 	sdf.parse(dateStr);</span><br><span class="line">		 &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">		 	e.printStackTrace();</span><br><span class="line">		 &#125;</span><br><span class="line">		 &#125;).start();</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例8：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Integer i = <span class="number">0</span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">	 List&lt;Thread&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	 <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">2</span>; j++) &#123;</span><br><span class="line">		 Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">		 <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">5000</span>; k++) &#123;</span><br><span class="line">		 	<span class="keyword">synchronized</span> (i) &#123;</span><br><span class="line">		 	i++;</span><br><span class="line">		 &#125;</span><br><span class="line">		 &#125;</span><br><span class="line">	 &#125;, <span class="string">&quot;&quot;</span> + j);</span><br><span class="line">	 list.add(thread);</span><br><span class="line">	 &#125;</span><br><span class="line">	 list.stream().forEach(t -&gt; t.start());</span><br><span class="line">	 list.stream().forEach(t -&gt; &#123;</span><br><span class="line">		 <span class="keyword">try</span> &#123;</span><br><span class="line">		 	t.join();</span><br><span class="line">		 &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		 	e.printStackTrace();</span><br><span class="line">		 &#125;</span><br><span class="line"> &#125;);</span><br><span class="line">  	log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="习题"><a href="#习题" class="headerlink" title="习题"></a>习题</h4><p><strong>买票练习</strong></p>
<p>测试下面代码是否存在线程安全问题，并尝试改正</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.Vector;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExerciseSellDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="comment">//模拟多人卖票</span></span><br><span class="line">        TicketWindow window = <span class="keyword">new</span> TicketWindow(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// 所有线程的集合（由于threadList在主线程中，不被共享，因此使用ArrayList不会出现线程安全问题）</span></span><br><span class="line">        List&lt;Thread&gt; threadList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 卖出的票数统计(Vector为线程安全类)</span></span><br><span class="line">        List&lt;Integer&gt; amountList = <span class="keyword">new</span> Vector&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">int</span> amount = window.sell(random.nextInt(<span class="number">5</span>) + <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    amountList.add(amount);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            threadList.add(thread);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threadList) &#123;</span><br><span class="line">            thread.join();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//统计剩余票数和卖出去的票</span></span><br><span class="line">        System.out.println(<span class="string">&quot;剩余票数：&quot;</span> + window.getCount());</span><br><span class="line">        System.out.println(<span class="string">&quot;卖出去的票数：&quot;</span> + amountList.stream().mapToInt(i -&gt; i).sum());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//买票窗口</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TicketWindow</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TicketWindow</span><span class="params">(<span class="keyword">int</span> count)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.count = count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取票余数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//售票</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">sell</span><span class="params">(<span class="keyword">int</span> amount)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (count &gt;= amount)&#123;</span><br><span class="line">            <span class="keyword">this</span>.count -= amount;</span><br><span class="line">            <span class="keyword">return</span> amount;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">执行结果：</span><br><span class="line">剩余票数：<span class="number">0</span></span><br><span class="line">卖出去的票数：<span class="number">1000</span></span><br></pre></td></tr></table></figure>

<p><strong>这行代码没成功</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /L %n (<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>) <span class="keyword">do</span> java ExerciseSellDemo</span><br></pre></td></tr></table></figure>

<p><strong>转账练习</strong></p>
<p>测试下面代码是否存在线程安全问题，并尝试改正</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExerciseTransfer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        Account a = <span class="keyword">new</span> Account(<span class="number">1000</span>);</span><br><span class="line">        Account b = <span class="keyword">new</span> Account(<span class="number">1000</span>);</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                a.transfer(b, random.nextInt(<span class="number">5</span>) + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                b.transfer(a, random.nextInt(<span class="number">5</span>) + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        <span class="comment">// 查看转账2000次后的总金额</span></span><br><span class="line">        System.out.println(<span class="string">&quot;total:&quot;</span>+ (a.getMoney() + b.getMoney()));<span class="comment">//total:2000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> money;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">(<span class="keyword">int</span> money)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMoney</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> money;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMoney</span><span class="params">(<span class="keyword">int</span> money)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account target, <span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(Account.class) &#123;   //锁住Account类，因为涉及到A.money和B.money。</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.money &gt;= amount) &#123;</span><br><span class="line">                <span class="keyword">this</span>.setMoney(<span class="keyword">this</span>.getMoney() - amount);</span><br><span class="line">                target.setMoney(target.getMoney() + amount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Monintor概念"><a href="#Monintor概念" class="headerlink" title="Monintor概念"></a>Monintor概念</h4><p><strong>对象头</strong></p>
<p>以32位虚拟机为例</p>
<p>普通对象</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfpUc4"><img src="https://s1.ax1x.com/2020/09/17/wfpUc4.png" alt="wfpUc4.png"></a></p>
<p>数组对象</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfpsN6"><img src="https://s1.ax1x.com/2020/09/17/wfpsN6.png" alt="wfpsN6.png"></a></p>
<p>Mark Word结构</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfphDA"><img src="https://s1.ax1x.com/2020/09/17/wfphDA.png" alt="wfphDA.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wf98rd"><img src="https://s1.ax1x.com/2020/09/17/wf98rd.png" alt="wf98rd.png"></a></p>
<p><strong>Monintor</strong></p>
<p>Monintor被翻译为<strong>监视器</strong>或<strong>管程</strong></p>
<p>每个Java对象都可以关联一个Monintor对象，如果使用synchronized给对象（重量级）之后，该对象头的Mark Word中就没设置指向Monintor对象的指针</p>
<p>Monintor结构如下：</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfF9eJ"><img src="https://s1.ax1x.com/2020/09/17/wfF9eJ.png" alt="wfF9eJ.png"></a></p>
<p>*刚开始Monintor中Owner位null</p>
<p>*当Thread-2执行sychronized(obj)就会将Monintor的所有者Owner置为Thread-2，Monintor中只能有一个Owner</p>
<p>*在Thread-2上锁的过程中，如果Thread-3,Thread-4,Thread-5也来执行sychronized(obj)，就会进入EntryListBLOCKED</p>
<p>*Thread-2执行完同步代码块的内容，然后唤醒EntryList中等待的竞争锁，竞争时非公平的</p>
<p>*图中WaitSet中的Thread-0,Thread-1是之前获得过锁，但条件不满足进入WAITING状态的线程，后面讲wait-notify时会分析</p>
<p><strong>注意</strong></p>
<p>*synchronized必须是进入同一个对象的monitor才有上述的效果</p>
<p>*不加synchronized的对象不会关联监视器，不遵从以上规则</p>
<p><strong>原理之synchronized</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(lock)&#123;</span><br><span class="line">		counter++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的字节码为：</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfFcXF"><img src="https://s1.ax1x.com/2020/09/17/wfFcXF.png" alt="wfFcXF.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfF4t1"><img src="https://s1.ax1x.com/2020/09/17/wfF4t1.png" alt="wfF4t1.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfkCjS"><img src="https://s1.ax1x.com/2020/09/17/wfkCjS.png" alt="wfkCjS.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfkg8P"><img src="https://s1.ax1x.com/2020/09/17/wfkg8P.png" alt="wfkg8P.png"></a></p>
<h4 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h4><p>轻量级锁的使用场景：如果一个对象虽然有对线程访问，但多线程访问的时间是错开的（也就是没有竞争），那么可以使用轻量级锁来优化</p>
<p>轻量级锁对使用者是透明的，即语法依然是synchronized</p>
<p>假设有两个方法同步块，利用同一个对象加锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mehtod1</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(obj)&#123;</span><br><span class="line">		<span class="comment">//同步块A</span></span><br><span class="line">		method2();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(obj)&#123;</span><br><span class="line">		<span class="comment">//同步块B</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>*创建锁记录（Lock Record)对象，每个线程的栈帧都会包含一个锁记录的结构，内存可以储存锁定对象的Mark Word</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfemOf"><img src="https://s1.ax1x.com/2020/09/17/wfemOf.png" alt="wfemOf.png"></a></p>
<p>*让记录中Object reference指向锁对象，并尝试用cas替换Object的Mark Word,将Mark Word的值存入锁记录</p>
<p><img src="https://s1.ax1x.com/2020/09/17/wfeY60.png" alt="wfeY60.png"></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfeY60"></a></p>
<p>*如果cas替换成功，对象头存储了锁记录地址和状态00.表示由线程给对象加锁，这时图示如下</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfKkHf"><img src="https://s1.ax1x.com/2020/09/17/wfKkHf.png" alt="wfKkHf.png"></a></p>
<p>*如果cas失败，有两种情况</p>
<p>​    *如果其它线程已经持有了该Object的轻量级锁，这时表明有竞争，进入锁膨胀的过程</p>
<p>​    *如果是自己执行了synchronized锁重入，那么在添加一条Lock Record作为重入的计数。</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfK1bV"><img src="https://s1.ax1x.com/2020/09/17/wfK1bV.png" alt="wfK1bV.png"></a></p>
<p>*当退出synchronized代码块（解锁时）如果有取值为null的锁记录，表示有重入，这时重置锁记录，表示重入计数减一。</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfKugs"><img src="https://s1.ax1x.com/2020/09/17/wfKugs.png"></a></p>
<p>*当退出synchronized代码块（解锁时）锁记录的值不为null，这时使用cas将Mark Word的值恢复给对象头</p>
<p>​    *成功，则解锁成功</p>
<p>​    *失败，说明轻量级锁进行了膨胀或已经升级为重量级锁，进入重量级锁解锁流程</p>
<h4 id="锁膨胀"><a href="#锁膨胀" class="headerlink" title="锁膨胀"></a><strong>锁膨胀</strong></h4><p>如果在尝试加轻量级锁的过程中，CAS操作无法成功，这时一种情况就是有其它线程为此对象加上了轻量级锁（有竞争），这时需要进行锁膨胀，将轻量级锁变为重量级锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span></span>&#123;</span><br><span class="line">	sychronezed(obj)&#123;</span><br><span class="line">		<span class="comment">//同步块</span></span><br><span class="line"> 	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>*当Thread-1进行轻量级加锁时，Thread-0已经对该对象加了轻量级锁</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfQAfg"><img src="https://s1.ax1x.com/2020/09/17/wfQAfg.png" alt="wfQAfg.png"></a></p>
<p>*这时Thread-1加轻量级锁失败，进入<strong>膨胀流程</strong></p>
<p>​    *即为Object对象<strong>申请Monitor锁</strong>，让Object指向重量级锁地址。</p>
<p>​    *然后自己进入Monitor的EntryListBLOCKED</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfQlkT"><img src="https://s1.ax1x.com/2020/09/17/wfQlkT.png" alt="wfQlkT.png"></a></p>
<p>*当Thread-0推出同步块解锁时，使用cas将Mark Word的值恢复给对象头，失败。这时会进入重量级解锁流程，即按照Monitor地址找到Monitor对象，设置Owner为null，唤醒EntryList中BLOCKED线程</p>
<h4 id="自旋优化"><a href="#自旋优化" class="headerlink" title="自旋优化"></a>自旋优化</h4><p>重量级锁竞争的时候，还可以使用自旋来进行优化，如果当前线程自旋成功（即这时候持锁线程已经退出了同步块，释放了锁），这时当前线程就可以避免阻塞。</p>
<p>自旋重试成功的情况</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wf3VpD"><img src="https://s1.ax1x.com/2020/09/17/wf3VpD.png" alt="wf3VpD.png"></a></p>
<p>自旋重试失败的情况</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wf3e6H"><img src="https://s1.ax1x.com/2020/09/17/wf3e6H.png" alt="wf3e6H.png"></a></p>
<p>*在Java6之后自旋锁是自适应的，比如对象刚刚的一次自旋操作成功过，那么认为这次自旋成功的可能性会高，就多自旋几次；反之，就少自旋甚至不自旋，总之，比较智能。</p>
<p>*自旋会占用CPU时间，单核CPU自旋就是浪费，多核CPU自旋才能发挥优势。</p>
<p>*Java7之后不能控制是否开启自旋功能。</p>
<h4 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h4><p>轻量级锁在没有竞争时（就自己这个线程），每次重入仍然需要执行CAS操作。</p>
<p>Java6中引入了偏向锁来做进一步优化：只用每一次使用CAS将线程ID设置到对象的Mark Word头，之后发现这个线程ID是自己的就表示没有竞争，不用重新CAS。以后只要不发生竞争，这个对象就归该线程所有</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m1</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(obj)&#123;</span><br><span class="line">		<span class="comment">//同步块A</span></span><br><span class="line">		m2();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m2</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(obj)&#123;</span><br><span class="line">		<span class="comment">//同步块B</span></span><br><span class="line">		m3();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m3</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(obj)&#123;</span><br><span class="line">		<span class="comment">//同步块C</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>轻量级锁<img src="https://s1.ax1x.com/2020/09/17/wfGFzD.png" alt="wfGFzD.png"></p>
<p>偏向锁</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfGmdI"><img src="https://s1.ax1x.com/2020/09/17/wfGmdI.png" alt="wfGmdI.png"></a></p>
<p><strong>偏向状态</strong></p>
<p>回忆一下对象头格式</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfNHv8"><img src="https://s1.ax1x.com/2020/09/17/wfNHv8.png" alt="wfNHv8.png"></a></p>
<p>一个对象创建时：</p>
<p>*如果开启了偏向锁（默认开启），那么对象创建后，<strong>mark word值为0x05即最后3位为101</strong>，这时它的thread、epoch、age都为0</p>
<p>*偏向锁是<strong>默认是延迟的</strong>，不会在程序启动时立即生效，如果想避免延迟，可以加JVM参数-xx:BiasedLockingStartupDelay=0来禁用延迟</p>
<p>*如果没有开启偏向锁，那么对象创建后，mark word值为0x01即最后3位001，这时它的hashcode、age都为0，第一次用到hashcode时才会赋值。</p>
<p>1）测试延迟特性</p>
<p>2）测试偏向锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>利用jol第三方工具来查看对象头信息（注意这里我扩展了jal让他输出更为简洁）</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfNLDg"><img src="https://s1.ax1x.com/2020/09/17/wfNLDg.png" alt="wfNLDg.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfUSCq"><img src="https://s1.ax1x.com/2020/09/17/wfUSCq.png" alt="wfUSCq.png"></a></p>
<p><strong>注意</strong></p>
<p>处于偏向锁的对象锁后，线程id仍存储于对象头中</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfUiKU"><img src="https://s1.ax1x.com/2020/09/17/wfUiKU.png" alt="wfUiKU.png"></a></p>
<p>4）</p>
<p>使用hashcode会禁用偏向锁</p>
<p><strong>撤销偏向锁</strong></p>
<p>优先状态：偏向锁–&gt;轻量级锁–&gt;重量级锁</p>
<p><strong>撤销-调用对象hashCode</strong></p>
<p>调用了对象的hashCode,但偏向锁的对象mark word中存储的是线程id，如果调用hashCode会导致偏向锁被撤销</p>
<p>*轻量级锁会在锁记录中记录hashCode</p>
<p>*重量级锁会在Monitor中记录hashCode</p>
<p>在调用hashCode后使用偏向锁，记得去掉-xx:UseBiasedLocking</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfUodJ"><img src="https://s1.ax1x.com/2020/09/17/wfUodJ.png" alt="wfUodJ.png"></a></p>
<p><strong>撤销-其它线程使用对象</strong></p>
<p>当有其它线程使用偏向锁对象时，会将偏向锁升级为轻量级锁</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfUHiR"><img src="https://s1.ax1x.com/2020/09/17/wfUHiR.png" alt="wfUHiR.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfa4pt"><img src="https://s1.ax1x.com/2020/09/17/wfa4pt.png" alt="wfa4pt.png"></a></p>
<p><strong>撤销-调用wait/notify</strong></p>
<p>撤销-调用wait/notify也会使得偏向锁/轻量级锁升级为重量级锁，因为wait/notify为重量级锁的机制。</p>
<p><strong>批量重偏向</strong></p>
<p>如果对象虽然被多个线程访问，但没有竞争，这时偏向了线程t1的对象仍有机会重新偏向t2，重偏向重置对象的Thread ID</p>
<p><strong>当撤销偏向锁阙值超过20次后</strong>，就、jvm会这样觉得，我是不是偏向错了呢，于是会给这些对象加锁时重新偏向至加锁线程</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wf0511"><img src="https://s1.ax1x.com/2020/09/17/wf0511.png" alt="wf0511.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wf07nK"><img src="https://s1.ax1x.com/2020/09/17/wf07nK.png" alt="wf07nK.png"></a></p>
<p><strong>批量撤销</strong></p>
<p>当撤销偏向阙值超过40次后，jvm会这样觉得，自己确实偏向错了，根本不该偏向。于是整个类的所有对象都会变为不可偏向的，新建的对象也是不可偏向的。</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wf0b7D"><img src="https://s1.ax1x.com/2020/09/17/wf0b7D.png" alt="wf0b7D.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wf0LAe"><img src="https://s1.ax1x.com/2020/09/17/wf0LAe.png" alt="wf0LAe.png"></a></p>
<h4 id="锁消除"><a href="#锁消除" class="headerlink" title="锁消除"></a>锁消除</h4><p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfbVjP"><img src="https://s1.ax1x.com/2020/09/18/wfbVjP.png" alt="wfbVjP.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/wfbenf"><img src="https://s1.ax1x.com/2020/09/18/wfbenf.png" alt="wfbenf.png"></a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/09/16/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%AE%A1%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="ckf9sc8sn000vtkvwcvns4b2y" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/09/18/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%AE%A1%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Java并发编程共享模型之管程（二）
        
      </div>
    </a>
  
  
    <a href="/2020/09/15/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Java并发编程之线程基础</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/19/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%86%85%E5%AD%98%EF%BC%88%E4%B8%80%EF%BC%89/">java并发编程共享模型之内存（一）</a>
          </li>
        
          <li>
            <a href="/2020/09/19/ReentrantLock/">ReentrantLock</a>
          </li>
        
          <li>
            <a href="/2020/09/18/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%AE%A1%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89/">Java并发编程共享模型之管程（二）</a>
          </li>
        
          <li>
            <a href="/2020/09/16/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%AE%A1%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/">Java并发编程共享模型之管程（一）</a>
          </li>
        
          <li>
            <a href="/2020/09/15/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/">Java并发编程之线程基础</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 我的笔记<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>